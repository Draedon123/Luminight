var t=Object.defineProperty,e=(e,i,s)=>((e,i,s)=>i in e?t(e,i,{enumerable:1,configurable:1,writable:1,value:s}):e[i]=s)(e,"symbol"!=typeof i?i+"":i,s);function i(t){return t[Math.floor(Math.random()*t.length)]}!function(){const t=document.createElement("link").relList;if(!(t&&t.supports&&t.supports("modulepreload"))){for(const t of document.querySelectorAll('link[rel="modulepreload"]'))e(t);new MutationObserver(t=>{for(const i of t)if("childList"===i.type)for(const t of i.addedNodes)"LINK"===t.tagName&&"modulepreload"===t.rel&&e(t)}).observe(document,{childList:1,subtree:1})}function e(t){if(t.ep)return;t.ep=1;const e=function(t){const e={};return t.integrity&&(e.integrity=t.integrity),t.referrerPolicy&&(e.referrerPolicy=t.referrerPolicy),"use-credentials"===t.crossOrigin?e.credentials="include":"anonymous"===t.crossOrigin?e.credentials="omit":e.credentials="same-origin",e}(t);fetch(t.href,e)}}();class s{constructor(t=1/0){e(this,"array"),e(this,"maxLength"),this.array=[],this.maxLength=t}*[Symbol.iterator](){for(let t=0;t<this.array.length;t++)yield this.array[t]}add(t){this.array.includes(t)||this.array.length===this.maxLength||this.array.push(t)}remove(t){const e=this.array.indexOf(t);-1!==e&&this.array.splice(e,1)}get(t){return this.array[t]}has(t){return this.array.includes(t)}random(){return i(this.array)}indexOf(t){return this.array.indexOf(t)}clear(){this.array.splice(0,this.size)}get size(){return this.array.length}}class h{constructor(t,i){e(this,"width"),e(this,"height"),e(this,"tiles"),this.tiles=[],this.width=t%2==0?t+1:t,this.height=i%2==0?i+1:i}create(){this.tiles.splice(0,this.tiles.length);for(let t=0;t<this.width;t++)for(let e=0;e<this.height;e++)this.tiles.push({x:e,y:t,isWall:1});const t=this.getTile(1,1),e=new s,h=new Set;for(t.isWall=0,h.add(this.getTileIndex(t)),e.add(this.getTile(3,1)),e.add(this.getTile(1,3));e.size>0;){const t=e.random(),s=this.getNeighbours(t,2),a=i(s.filter(t=>h.has(this.getTileIndex(t.tile)))),r=this.getTile(t.x+a.direction[0],t.y+a.direction[1]);h.add(this.getTileIndex(t)),r.isWall=0,t.isWall=0,e.remove(t);for(const t of s)t.tile&&!h.has(this.getTileIndex(t.tile))&&e.add(t.tile)}}getTile(t,e){return this.tiles[this.getTileIndex(t,e)]}getTileIndex(t,e){return"number"!=typeof t&&(e=t.y,t=t.x),t+this.height*e}getNeighbours(t,e=1){return[[1,0],[0,1],[-1,0],[0,-1]].map(i=>({tile:this.getTile(t.x+i[0]*e,t.y+i[1]*e),direction:i})).filter(t=>t.tile&&t.tile.x>0&&t.tile.y>0&&t.tile.x<this.width-1&&t.tile.y<this.height-1)}*[Symbol.iterator](){yield*this.tiles}}class a{constructor(t=0,i=0){e(this,"x"),e(this,"y"),this.x=t,this.y=i}}const r=class t{constructor(t){e(this,"maze"),e(this,"position"),e(this,"fov"),this.maze=t,this.position=new a(1,1),this.fov=45}moveX(t){this.move(t,0)}moveY(t){this.move(0,t)}move(e,i){var s,h,a,r,n,l,o,c;const d=this.position.x+e,m=this.position.y+i,y=Math.floor(d+t.SIZE/2),g=Math.ceil(d-t.SIZE/2),u=Math.ceil(m-t.SIZE/2),f=Math.floor(m+t.SIZE/2);e<0&&!(null==(s=this.maze.getTile(y,u))?void 0:s.isWall)&&!(null==(h=this.maze.getTile(y,f))?void 0:h.isWall)||e>0&&!(null==(a=this.maze.getTile(g,u))?void 0:a.isWall)&&!(null==(r=this.maze.getTile(g,f))?void 0:r.isWall)||0===e?this.position.x=d:this.position.x=Math.round(d)+Math.sign(e)*t.SIZE/2,i<0&&!(null==(n=this.maze.getTile(y,f))?void 0:n.isWall)&&!(null==(l=this.maze.getTile(g,f))?void 0:l.isWall)||i>0&&!(null==(o=this.maze.getTile(y,u))?void 0:o.isWall)&&!(null==(c=this.maze.getTile(g,u))?void 0:c.isWall)||0===i?this.position.y=m:this.position.y=Math.round(m)+Math.sign(i)*t.SIZE/2}};e(r,"SIZE",.5);let n=r;const l=2*Math.PI,o=document.getElementById("main"),c=new h(30,30);c.create();const d=new n(c),m=new class{constructor(t,i,s){e(this,"maze"),e(this,"player"),e(this,"playerAuraRadius"),e(this,"canvas"),e(this,"ctx"),e(this,"mask"),e(this,"maskCTX"),this.maze=i,this.player=s,this.playerAuraRadius=1.5,this.canvas=t,this.ctx=t.getContext("2d"),this.mask=document.createElement("canvas"),this.maskCTX=this.mask.getContext("2d"),new ResizeObserver(t=>{const e=t[0].devicePixelContentBoxSize[0],i=e.inlineSize,s=e.blockSize;this.canvas.width=i,this.canvas.height=s;const h=this.getTileSize(),a=this.maze.width*h,r=this.maze.height*h;this.mask.width=a,this.mask.height=r,this.render()}).observe(t)}render(){this.ctx.fillStyle="#333",this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height),this.renderMaze(),this.renderPlayer(),this.renderMask()}renderMaze(){const t=this.getTileSize(),e=this.getMazeCorner();for(const i of this.maze){const s=t*i.x+e.x,h=t*(this.maze.height-i.y-1)+e.y;this.ctx.fillStyle=i.isWall?"#000":"#fff",this.ctx.fillRect(s,h,t,t)}}renderPlayer(){const t=this.getTileSize(),e=n.SIZE*t,i=this.getPlayerRenderPosition();this.ctx.fillStyle="#f00",this.ctx.fillRect(i.x,i.y,e,e)}renderMask(){const t=this.getMazeCorner(),e=this.getTileSize(),i=this.playerAuraRadius*e,s=this.getPlayerRenderPosition(),h=e*n.SIZE;this.maskCTX.fillStyle="#222",this.maskCTX.fillRect(0,0,this.mask.width,this.mask.height);const a=s.x-t.x+h/2,r=s.y-t.y+h/2;this.maskCTX.beginPath(),this.maskCTX.arc(a,r,i,0,l),this.maskCTX.closePath(),this.maskCTX.save(),this.maskCTX.clip(),this.maskCTX.clearRect(a-i,r-i,2*i,2*i),this.maskCTX.restore();const o=this.maskCTX.createRadialGradient(a,r,.5*i,a,r,i);o.addColorStop(0,"#0000"),o.addColorStop(.7,"#1118"),o.addColorStop(1,"#222"),this.maskCTX.fillStyle=o,this.maskCTX.fill(),this.ctx.drawImage(this.mask,t.x,t.y)}getTileSize(){return Math.floor(.95*Math.min(this.canvas.width/this.maze.width,this.canvas.height/this.maze.height))}getMazeCorner(){const t=this.getTileSize();return new a((this.canvas.width-t*this.maze.width)/2,(this.canvas.height-t*this.maze.height)/2)}getPlayerRenderPosition(){const t=this.getTileSize(),e=n.SIZE*t,i=this.getMazeCorner();return new a(i.x+this.player.position.x*t+.5*(t-e),i.y+(this.maze.height-this.player.position.y-1)*t+.5*(t-e))}}(o,c,d),y=new class{constructor(t={}){e(this,"settings"),e(this,"callbacks",[]),e(this,"frameID"),e(this,"lastFrameTime"),e(this,"totalTime"),e(this,"frame"),this.frameID=null,this.lastFrameTime=0,this.totalTime=0,this.frame=1,this.callbacks=[],this.settings={wormholeThreshold:t.wormholeThreshold??500}}start(){this.running||(this.frame=1,this.totalTime=0,this.lastFrameTime=-1,this.frameID=requestAnimationFrame(this.tick.bind(this)))}stop(){this.running&&(cancelAnimationFrame(this.frameID),this.frameID=null)}toggle(){this.running?this.stop():this.start()}addCallback(t){this.callbacks.push(t)}tick(t){this.lastFrameTime<0&&(this.lastFrameTime=t);const e=t-this.lastFrameTime,i=this.totalTime+e;if(e<this.settings.wormholeThreshold){const t={deltaTime:e,totalTime:i,frame:this.frame++};for(const e of this.callbacks)e(t);this.totalTime=i}this.lastFrameTime=t,this.frameID=requestAnimationFrame(this.tick.bind(this))}get running(){return null!==this.frameID}},g={FORWARD:"KeyW",LEFT:"KeyA",BACKWARDS:"KeyS",RIGHT:"KeyD"},u=new class{constructor(t){e(this,"keybinds"),e(this,"keysDown"),this.keysDown=new Set,this.keybinds=new Set(t)}addEventListeners(){document.addEventListener("keydown",this.onKeyDown.bind(this)),document.addEventListener("keyup",this.onKeyUp.bind(this))}isKeyDown(t){return this.keysDown.has(t)}onKeyDown(t){const e=t.code;this.keybinds.has(e)&&this.keysDown.add(e)}onKeyUp(t){const e=t.code;this.keysDown.delete(e)}}(Object.values(g));u.addEventListeners();const f=.0025;y.addCallback(t=>{u.isKeyDown(g.FORWARD)&&d.moveY(f*t.deltaTime),u.isKeyDown(g.BACKWARDS)&&d.moveY(-.0025*t.deltaTime),u.isKeyDown(g.LEFT)&&d.moveX(-.0025*t.deltaTime),u.isKeyDown(g.RIGHT)&&d.moveX(f*t.deltaTime),m.render()}),y.start();