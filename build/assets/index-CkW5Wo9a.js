var t=Object.defineProperty,i=(i,e,s)=>((i,e,s)=>e in i?t(i,e,{enumerable:1,configurable:1,writable:1,value:s}):i[e]=s)(i,"symbol"!=typeof e?e+"":e,s);!function(){const t=document.createElement("link").relList;if(!(t&&t.supports&&t.supports("modulepreload"))){for(const t of document.querySelectorAll('link[rel="modulepreload"]'))i(t);new MutationObserver(t=>{for(const e of t)if("childList"===e.type)for(const t of e.addedNodes)"LINK"===t.tagName&&"modulepreload"===t.rel&&i(t)}).observe(document,{childList:1,subtree:1})}function i(t){if(t.ep)return;t.ep=1;const i=function(t){const i={};return t.integrity&&(i.integrity=t.integrity),t.referrerPolicy&&(i.referrerPolicy=t.referrerPolicy),"use-credentials"===t.crossOrigin?i.credentials="include":"anonymous"===t.crossOrigin?i.credentials="omit":i.credentials="same-origin",i}(t);fetch(t.href,i)}}();class e{constructor(t=0,e=0){i(this,"x"),i(this,"y"),this.x=t,this.y=e}}const s=class t{constructor(t){i(this,"maze"),i(this,"position"),this.maze=t,this.position=new e(1,1)}moveX(t){this.move(t,0)}moveY(t){this.move(0,t)}move(i,e){var s,h,n,a,r,o,l,d;const m=this.position.x+i,c=this.position.y+e,u=Math.floor(m+t.SIZE/2),g=Math.ceil(m-t.SIZE/2),y=Math.ceil(c-t.SIZE/2),p=Math.floor(c+t.SIZE/2);i<0&&!(null==(s=this.maze.getTile(u,y))?void 0:s.isWall)&&!(null==(h=this.maze.getTile(u,p))?void 0:h.isWall)||i>0&&!(null==(n=this.maze.getTile(g,y))?void 0:n.isWall)&&!(null==(a=this.maze.getTile(g,p))?void 0:a.isWall)||0===i?this.position.x=m:this.position.x=Math.round(m)+Math.sign(i)*t.SIZE/2,e<0&&!(null==(r=this.maze.getTile(u,p))?void 0:r.isWall)&&!(null==(o=this.maze.getTile(g,p))?void 0:o.isWall)||e>0&&!(null==(l=this.maze.getTile(u,y))?void 0:l.isWall)&&!(null==(d=this.maze.getTile(g,y))?void 0:d.isWall)||0===e?this.position.y=c:this.position.y=Math.round(c)+Math.sign(e)*t.SIZE/2}};i(s,"SIZE",.5);let h=s;const n=2*Math.PI;class a{constructor(t,e,s){i(this,"maze"),i(this,"player"),i(this,"playerAuraRadius"),i(this,"auraIntensity"),i(this,"maskAlpha"),i(this,"entities"),i(this,"ctx"),i(this,"canvas"),i(this,"mask"),i(this,"maskCTX"),i(this,"mazeCanvas"),i(this,"mazeCTX"),i(this,"renderedMaze"),i(this,"wallTexture"),i(this,"dirtTexture"),this.maze=e,this.player=s,this.playerAuraRadius=1.5,this.auraIntensity=1,this.maskAlpha=255,this.canvas=t,this.ctx=t.getContext("2d"),this.mask=document.createElement("canvas"),this.maskCTX=this.mask.getContext("2d"),this.mazeCanvas=document.createElement("canvas"),this.mazeCTX=this.mazeCanvas.getContext("2d"),this.renderedMaze=0,this.wallTexture=new Image,this.dirtTexture=new Image,this.wallTexture.src="/Luminight/tiles/wall.png",this.dirtTexture.src="/Luminight/tiles/dirt.png",this.entities=[],new ResizeObserver(t=>{const i=t[0].devicePixelContentBoxSize[0],e=i.inlineSize,s=i.blockSize;if(0===e||0===s)return;this.canvas.width=e,this.canvas.height=s;const h=this.getTileSize(),n=this.maze.width*h,a=this.maze.height*h;this.mask.width=n,this.mask.height=a,this.mazeCanvas.width=n,this.mazeCanvas.height=a,this.renderedMaze=0,this.render()}).observe(t)}render(){this.ctx.fillStyle="#333",this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height),this.renderMaze(),this.renderEntities(),this.renderPlayer(),this.renderMask()}renderMaze(){const t=this.getMazeCorner();if(!this.renderedMaze){const t=this.getTileSize();for(const i of this.maze){const e=t*i.x,s=t*(this.maze.height-i.y-1);this.mazeCTX.drawImage(i.isWall?this.wallTexture:this.dirtTexture,e,s,t,t)}this.renderedMaze=1}this.ctx.drawImage(this.mazeCanvas,t.x,t.y)}renderPlayer(){const t=h.SIZE*this.getTileSize(),i=this.getRenderPosition(this.player.position,h.SIZE);this.ctx.fillStyle="#f00",this.ctx.fillRect(i.x,i.y,t,t)}renderMask(){const t=this.getMazeCorner(),i=this.getTileSize(),e=Math.floor(this.playerAuraRadius*i),s=this.getRenderPosition(this.player.position,h.SIZE),a=i*h.SIZE,r=`rgba(32, 32, 32, ${this.maskAlpha})`;this.maskCTX.clearRect(0,0,this.mask.width,this.mask.height),this.maskCTX.fillStyle=r,this.maskCTX.fillRect(0,0,this.mask.width,this.mask.height);const o=s.x-t.x+a/2,l=s.y-t.y+a/2;this.maskCTX.beginPath(),this.maskCTX.arc(o,l,e,0,n),this.maskCTX.closePath(),this.maskCTX.save(),this.maskCTX.clip(),this.maskCTX.clearRect(o-e,l-e,2*e,2*e);const d=this.maskCTX.createRadialGradient(o,l,.5*e,o,l,e);d.addColorStop(0,"#0000"),d.addColorStop(.7,"#1118"),d.addColorStop(1,r),this.maskCTX.fillStyle=d,this.maskCTX.fill(),this.maskCTX.fillStyle=`rgba(32, 32, 32, ${1-this.auraIntensity})`,this.maskCTX.fill(),this.maskCTX.restore(),this.ctx.drawImage(this.mask,t.x,t.y)}renderEntities(){for(const t of this.entities)t.render(this)}getMazeCorner(){const t=this.getTileSize();return new e((this.canvas.width-t*this.maze.width)/2,(this.canvas.height-t*this.maze.height)/2)}getTileSize(){return Math.floor(.95*Math.min(this.canvas.width/this.maze.width,this.canvas.height/this.maze.height))}getRenderPosition(t,i){const s=this.getTileSize(),h=i*s,n=this.getMazeCorner();return new e(n.x+t.x*s+.5*(s-h),n.y+(this.maze.height-t.y-1)*s+.5*(s-h))}}function r(t){return t[Math.floor(Math.random()*t.length)]}function o(t){return t.splice(0,t.length)}class l{constructor(t=1/0){i(this,"array"),i(this,"maxLength"),this.array=[],this.maxLength=t}*[Symbol.iterator](){for(let t=0;t<this.array.length;t++)yield this.array[t]}add(t){this.array.includes(t)||this.array.length===this.maxLength||this.array.push(t)}remove(t){const i=this.array.indexOf(t);-1!==i&&this.array.splice(i,1)}get(t){return this.array[t]}has(t){return this.array.includes(t)}random(){return r(this.array)}indexOf(t){return this.array.indexOf(t)}clear(){o(this.array)}get size(){return this.array.length}}class d{constructor(t,e){i(this,"width"),i(this,"height"),i(this,"tiles"),this.tiles=[],this.width=t%2==0?t+1:t,this.height=e%2==0?e+1:e}create(){o(this.tiles);for(let t=0;t<this.width;t++)for(let i=0;i<this.height;i++)this.tiles.push({x:i,y:t,isWall:1});const t=this.getTile(1,1),i=new l,e=new Set;for(t.isWall=0,e.add(this.getTileIndex(t)),i.add(this.getTile(3,1)),i.add(this.getTile(1,3));i.size>0;){const t=i.random(),s=this.getNeighbours(t,2),h=r(s.filter(t=>e.has(this.getTileIndex(t.tile)))),n=this.getTile(t.x+h.direction[0],t.y+h.direction[1]);e.add(this.getTileIndex(t)),n.isWall=0,t.isWall=0,i.remove(t);for(const t of s)t.tile&&!e.has(this.getTileIndex(t.tile))&&i.add(t.tile)}return this}getTile(t,i){return this.tiles[this.getTileIndex(t,i)]}getTileIndex(t,i){return"number"!=typeof t&&(i=t.y,t=t.x),t+this.height*i}getNeighbours(t,i=1){return[[1,0],[0,1],[-1,0],[0,-1]].map(e=>({tile:this.getTile(t.x+e[0]*i,t.y+e[1]*i),direction:e})).filter(t=>t.tile&&t.tile.x>0&&t.tile.y>0&&t.tile.x<this.width-1&&t.tile.y<this.height-1)}*[Symbol.iterator](){yield*this.tiles}}class m{constructor(t={}){i(this,"settings"),i(this,"callbacks",[]),i(this,"frameID"),i(this,"lastFrameTime"),i(this,"totalTime"),i(this,"frame"),this.frameID=null,this.lastFrameTime=0,this.totalTime=0,this.frame=1,this.callbacks=[],this.settings={wormholeThreshold:t.wormholeThreshold??500}}start(){this.running||(this.frame=1,this.totalTime=0,this.lastFrameTime=-1,this.frameID=requestAnimationFrame(this.tick.bind(this)))}stop(){this.running&&(cancelAnimationFrame(this.frameID),this.frameID=null)}toggle(){this.running?this.stop():this.start()}addCallback(t){this.callbacks.push(t)}tick(t){this.lastFrameTime<0&&(this.lastFrameTime=t);const i=t-this.lastFrameTime,e=this.totalTime+i;if(i<this.settings.wormholeThreshold){const t={deltaTime:i,totalTime:e,frame:this.frame++};for(const i of this.callbacks)i(t);this.totalTime=e}this.lastFrameTime=t,null!==this.frameID&&(this.frameID=requestAnimationFrame(this.tick.bind(this)))}get running(){return null!==this.frameID}}class c{constructor(t){i(this,"keybinds"),i(this,"keysDown"),this.keysDown=new Set,this.keybinds=new Set(t)}addEventListeners(){return document.addEventListener("keydown",this.onKeyDown.bind(this)),document.addEventListener("keyup",this.onKeyUp.bind(this)),this}isKeyDown(t){return this.keysDown.has(t)}onKeyDown(t){const i=t.code;this.keybinds.has(i)&&this.keysDown.add(i)}onKeyUp(t){const i=t.code;this.keysDown.delete(i)}}class u{constructor(t){i(this,"position"),i(this,"size"),i(this,"onCollision"),i(this,"texture"),this.position=new e,this.size=t.size??.5,this.texture=t.texture,this.onCollision=t.onCollision??(()=>{})}checkCollisions(t){const i=this.position.x+(1-this.size)/2,e=i+this.size,s=this.position.y+(1-this.size)/2,n=s+this.size,a=t.position.x+(1-h.SIZE)/2,r=a+h.SIZE,o=t.position.y+(1-h.SIZE)/2,l=o+h.SIZE;i<r&&e>a&&s<l&&n>o&&this.onCollision()}render(t){const i=t.getTileSize()*this.size,e=t.getRenderPosition(this.position,this.size);t.ctx.drawImage(this.texture.source,e.x,e.y,i,i)}}class g{constructor(t){i(this,"framesPerFrame"),i(this,"currentFrame"),i(this,"frame"),i(this,"frames"),this.frames=t,this.currentFrame=0,this.frame=0,this.framesPerFrame=1}get source(){return++this.frame%this.framesPerFrame===0&&this.currentFrame++,this.frames[this.currentFrame%this.frames.length]}static async create(...t){const i=t.map(t=>new Promise((i,e)=>{const s=new Image;s.onerror=e,s.onload=()=>{i(s)},s.src=t})),e=await Promise.all(i);return new g(e)}}class y extends u{constructor(t){super({texture:t,size:1})}static async create(){const t=await g.create(...Array.from({length:32},(t,i)=>"/Luminight/portal/"+(""+(i+1)).padStart(4,"0")+".png"));return new y(t)}}class p{constructor(){i(this,"data",[]),i(this,"indexMap",new Map)}left(t){return 2*t+1}right(t){return 2*t+2}parent(t){return Math.floor((t-1)/2)}swap(t,i){[this.data[t],this.data[i]]=[this.data[i],this.data[t]],this.indexMap.set(this.data[t].key,t),this.indexMap.set(this.data[i].key,i)}peek(){return this.data[0]}insert(t,i,e){if(this.indexMap.has(e))return void this.decreasePriority(e,i);const s={value:t,priority:i,key:e};this.data.push(s);const h=this.data.length-1;this.indexMap.set(e,h),this.bubbleUp(h)}bubbleUp(t){for(;t>0&&this.data[this.parent(t)].priority>this.data[t].priority;){const i=this.parent(t);this.swap(t,i),t=i}}extractMin(){if(0===this.data.length)return null;const t=this.data[0],i=this.data.pop();return this.indexMap.delete(t.key),this.data.length>0&&(this.data[0]=i,this.indexMap.set(i.key,0),this.minHeapify(0)),t}minHeapify(t){const i=this.left(t),e=this.right(t);let s=t;i<this.data.length&&this.data[i].priority<this.data[s].priority&&(s=i),e<this.data.length&&this.data[e].priority<this.data[s].priority&&(s=e),s!==t&&(this.swap(t,s),this.minHeapify(s))}decreasePriority(t,i){const e=this.indexMap.get(t);void 0!==e&&(i>=this.data[e].priority||(this.data[e].priority=i,this.bubbleUp(e)))}has(t){return this.indexMap.has(t)}isEmpty(){return 0===this.data.length}size(){return this.data.length}}class f extends u{constructor(t,e){super({texture:t,size:.8}),i(this,"movementSpeed"),i(this,"movementQueue"),this.movementSpeed=e.movementSpeed,this.movementQueue=[]}pathfind(t,i){o(this.movementQueue);const e=new p,s=new Map,h=new Map,n=new Set,a=(t,i)=>`${t},${i}`;for(const t of i.tiles){const i=t.x===this.position.x&&t.y===this.position.y?0:1/0,n=a(t.x,t.y);s.set(n,i),h.set(n,null),e.insert({tile:t,distance:i},i,n)}for(;!e.isEmpty();){const r=e.extractMin().value.tile,o=a(r.x,r.y);if(n.has(o))continue;if(n.add(o),r.x===t.x&&r.y===t.y)break;const l=s.get(o),d=[[r.x+1,r.y],[r.x-1,r.y],[r.x,r.y+1],[r.x,r.y-1]];for(const[t,n]of d){const o=i.getTile(t,n);if(void 0===o)continue;if(o.isWall)continue;const d=a(t,n),m=l+1;m<s.get(d)&&(s.set(d,m),h.set(d,r),e.decreasePriority(d,m))}}const r=[];let l=i.getTile(t.x,t.y)||null;for(;l;){r.unshift(l);const t=h.get(a(l.x,l.y));if(!t)break;l=t}for(const t of r)this.movementQueue.push(t)}tick(t,i){if(0===this.movementQueue.length){const t=new e(0,0);for(;i.getTile(t.x,t.y).isWall;)t.x=Math.floor(Math.random()*i.width),t.y=Math.floor(Math.random()*i.height);this.pathfind(t,i)}const s=this.movementQueue[0];let h=s.x-this.position.x,n=s.y-this.position.y;if(Math.abs(h)+Math.abs(n)<=.01)return this.movementQueue.shift(),this.position.x=Math.round(this.position.x),void(this.position.y=Math.round(this.position.y));const a=this.movementSpeed*t/Math.hypot(h,n);h*=a,n*=a,this.position.x+=h,this.position.y+=n}}const x={FORWARD:"KeyW",LEFT:"KeyA",BACKWARDS:"KeyS",RIGHT:"KeyD"};class k{constructor(t={}){var e,s;i(this,"canvas"),i(this,"maze"),i(this,"renderer"),i(this,"player"),i(this,"loop"),i(this,"keyboardManager"),i(this,"keybinds"),i(this,"thunderAudio"),i(this,"playerAuraRadius"),i(this,"movementSpeed"),i(this,"flickerSpeed"),i(this,"flickerRadius"),i(this,"lightningDuration"),i(this,"lightningRarity"),i(this,"lightningBrightness"),i(this,"enemyCount"),i(this,"onWin"),i(this,"onLose"),i(this,"initialised"),i(this,"portal"),i(this,"lightningCurrentLifetime"),this.canvas=document.createElement("canvas"),this.maze=new d((null==(e=t.maze)?void 0:e.width)??30,(null==(s=t.maze)?void 0:s.height)??30).create(),this.player=new h(this.maze),this.renderer=new a(this.canvas,this.maze,this.player),this.loop=new m,this.keybinds=t.keybinds??x,this.keyboardManager=new c(Object.values(this.keybinds)).addEventListeners(),this.movementSpeed=t.movementSpeed??.0025,this.flickerRadius=t.flickerRadius??.04,this.flickerSpeed=t.flickerSpeed??1/160,this.playerAuraRadius=t.playerAuraRadius??2,this.lightningDuration=t.lightningDuration_ms??500,this.lightningRarity=t.lightningRarity??25,this.lightningBrightness=t.lightningBrightness??.8,this.enemyCount=t.enemyCount??5,this.onWin=t.onWin??(()=>{}),this.onLose=t.onLose??(()=>{}),this.renderer.auraIntensity=0,this.lightningCurrentLifetime=0,this.thunderAudio=document.createElement("audio"),this.thunderAudio.volume=.1,this.initialised=0,this.loop.addCallback(this.tick.bind(this))}async initialise(){if(this.initialised)return;this.portal=await y.create(),this.portal.position={x:this.maze.width-2,y:this.maze.height-2},this.portal.onCollision=()=>{this.stop(),this.onWin()},await new Promise((t,i)=>{const e=()=>{t(),this.thunderAudio.removeEventListener("canplaythrough",e)};this.thunderAudio.addEventListener("canplaythrough",e),this.thunderAudio.onerror=i,this.thunderAudio.src="/Luminight/thunder.mp3"}),this.thunderAudio.addEventListener("ended",()=>{this.thunderAudio.pause()});const t=await g.create(...Array.from({length:4},(t,i)=>`/Luminight/ghost/${i}.png`)),i=Array.from({length:this.enemyCount},()=>{const i=new f(t,{movementSpeed:.8*this.movementSpeed});do{i.position.x=Math.floor(Math.random()*this.maze.width),i.position.y=Math.floor(Math.random()*this.maze.height)}while(i.position.x<this.maze.width/2&&i.position.y<this.maze.height/2||this.maze.getTile(i.position.x,i.position.y).isWall);return i});this.renderer.entities.push(this.portal,...i),this.initialised=1}mount(t){null===this.canvas.parentElement&&t.appendChild(this.canvas)}start(){this.loop.start()}tick(t){this.flicker(t.frame,t.deltaTime),this.lightningFlash(t.deltaTime),this.checkKeyboard(t.deltaTime);for(const i of this.renderer.entities)i.checkCollisions(this.player),i instanceof f&&i.tick(t.deltaTime,this.maze);this.renderer.render()}flicker(t,i){this.renderer.playerAuraRadius=this.playerAuraRadius+this.flickerRadius*Math.cos(t*i*this.flickerSpeed),this.renderer.auraIntensity=Math.min(Math.max(.2,this.renderer.auraIntensity+.15*(Math.random()-.5)),1)}checkKeyboard(t){this.keyboardManager.isKeyDown(this.keybinds.FORWARD)&&this.player.moveY(this.movementSpeed*t),this.keyboardManager.isKeyDown(this.keybinds.BACKWARDS)&&this.player.moveY(-this.movementSpeed*t),this.keyboardManager.isKeyDown(this.keybinds.LEFT)&&this.player.moveX(-this.movementSpeed*t),this.keyboardManager.isKeyDown(this.keybinds.RIGHT)&&this.player.moveX(this.movementSpeed*t)}lightningFlash(t){this.renderer.maskAlpha=1-this.lightningBrightness*this.lightningCurrentLifetime/this.lightningDuration,this.lightningCurrentLifetime=Math.max(this.lightningCurrentLifetime-t,0);const i=1/(this.lightningRarity*t);if(!(Math.random()>i)){if(this.thunderAudio.paused)this.thunderAudio.play();else{const t=this.thunderAudio.cloneNode();t.volume=.1,t.play()}this.lightningCurrentLifetime=this.lightningDuration}}stop(){this.loop.stop()}}(async()=>{const t=document.getElementById("game-container"),i=new k;await i.initialise(),i.mount(t);const e=document.getElementById("start"),s=document.getElementById("tutorial"),h=document.getElementById("win"),n=document.getElementById("banner");s.classList.remove("hidden"),i.onWin=()=>{n.classList.remove("hidden"),h.classList.remove("hidden")},e.addEventListener("click",()=>{n.classList.add("hidden"),s.classList.add("hidden"),i.start()})})();