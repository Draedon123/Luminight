var t=Object.defineProperty,i=(i,e,s)=>((i,e,s)=>e in i?t(i,e,{enumerable:1,configurable:1,writable:1,value:s}):i[e]=s)(i,"symbol"!=typeof e?e+"":e,s);!function(){const t=document.createElement("link").relList;if(!(t&&t.supports&&t.supports("modulepreload"))){for(const t of document.querySelectorAll('link[rel="modulepreload"]'))i(t);new MutationObserver(t=>{for(const e of t)if("childList"===e.type)for(const t of e.addedNodes)"LINK"===t.tagName&&"modulepreload"===t.rel&&i(t)}).observe(document,{childList:1,subtree:1})}function i(t){if(t.ep)return;t.ep=1;const i=function(t){const i={};return t.integrity&&(i.integrity=t.integrity),t.referrerPolicy&&(i.referrerPolicy=t.referrerPolicy),"use-credentials"===t.crossOrigin?i.credentials="include":"anonymous"===t.crossOrigin?i.credentials="omit":i.credentials="same-origin",i}(t);fetch(t.href,i)}}();class e{constructor(t=0,e=0){i(this,"x"),i(this,"y"),this.x=t,this.y=e}static subtract(t,i){return new e(t.x-i.x,t.y-i.y)}static add(t,i){return new e(t.x+i.x,t.y+i.y)}static scale(t,i){return new e(t.x*i,t.y*i)}add(t){return this.x+=t.x,this.y+=t.y,this}round(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this}scale(t){return this.x*=t,this.y*=t,this}equals(t){return this.x===t.x&&this.y===t.y}normalise(){return this.scale(1/this.magnitude)}get magnitude(){return Math.hypot(this.x,this.y)}}const s=class t{constructor(t){i(this,"maze"),i(this,"position"),this.maze=t,this.position=new e(1,1)}moveX(t){this.move(t,0)}moveY(t){this.move(0,t)}move(i,e){var s,n,h,a,r,o,l,d;const m=this.position.x+i,c=this.position.y+e,u=.9,p=Math.floor(m+(1-u*t.SIZE)/2),g=Math.floor(m+(1+u*t.SIZE)/2),y=Math.floor(c+(1-u*t.SIZE)/2),f=Math.floor(c+(1+u*t.SIZE)/2);(i<0&&!(null==(s=this.maze.getTile(p,f))?void 0:s.isWall)&&!(null==(n=this.maze.getTile(p,y))?void 0:n.isWall)||i>0&&!(null==(h=this.maze.getTile(g,f))?void 0:h.isWall)&&!(null==(a=this.maze.getTile(g,y))?void 0:a.isWall)||0===i)&&(this.position.x=m),(e<0&&!(null==(r=this.maze.getTile(p,y))?void 0:r.isWall)&&!(null==(o=this.maze.getTile(g,y))?void 0:o.isWall)||e>0&&!(null==(l=this.maze.getTile(p,f))?void 0:l.isWall)&&!(null==(d=this.maze.getTile(g,f))?void 0:d.isWall)||0===e)&&(this.position.y=c)}};i(s,"SIZE",.8);let n=s;class h{constructor(t){i(this,"framesPerFrame"),i(this,"currentFrame"),i(this,"frame"),i(this,"frames"),this.frames=t,this.currentFrame=0,this.frame=0,this.framesPerFrame=1}get source(){return++this.frame%this.framesPerFrame===0&&this.currentFrame++,this.frames[this.currentFrame%this.frames.length]}static async create(...t){const i=t.map(t=>new Promise((i,e)=>{const s=new Image;s.onerror=e,s.onload=()=>{i(s)},s.src=t})),e=await Promise.all(i);return new h(e)}}const a=2*Math.PI;class r{constructor(t,e,s){i(this,"maze"),i(this,"player"),i(this,"playerAuraRadius"),i(this,"auraIntensity"),i(this,"maskAlpha"),i(this,"entities"),i(this,"ctx"),i(this,"canvas"),i(this,"mask"),i(this,"maskCTX"),i(this,"mazeCanvas"),i(this,"mazeCTX"),i(this,"renderedMaze"),i(this,"initialised"),i(this,"wallTexture"),i(this,"dirtTexture"),i(this,"playerTexture"),this.maze=e,this.player=s,this.playerAuraRadius=1.5,this.auraIntensity=1,this.maskAlpha=255,this.canvas=t,this.ctx=t.getContext("2d"),this.mask=document.createElement("canvas"),this.maskCTX=this.mask.getContext("2d"),this.mazeCanvas=document.createElement("canvas"),this.mazeCTX=this.mazeCanvas.getContext("2d"),this.renderedMaze=0,this.initialised=0,this.entities=[],new ResizeObserver(t=>{const i=t[0].devicePixelContentBoxSize[0],e=i.inlineSize,s=i.blockSize;if(0===e||0===s)return;this.canvas.width=e,this.canvas.height=s;const n=this.getTileSize(),h=this.maze.width*n,a=this.maze.height*n;this.mask.width=h,this.mask.height=a,this.mazeCanvas.width=h,this.mazeCanvas.height=a,this.renderedMaze=0,this.render()}).observe(t)}render(){this.ctx.fillStyle="#333",this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height),this.renderMaze(),this.renderEntities(),this.renderPlayer(),this.renderMask()}renderMaze(){const t=this.getMazeCorner();if(!this.renderedMaze){const t=this.getTileSize();for(const i of this.maze){const e=t*i.position.x,s=t*(this.maze.height-i.position.y-1);this.mazeCTX.drawImage(i.isWall?this.wallTexture.source:this.dirtTexture.source,e,s,t,t)}this.renderedMaze=1}this.ctx.drawImage(this.mazeCanvas,t.x,t.y)}renderPlayer(){const t=n.SIZE*this.getTileSize(),i=this.getRenderPosition(this.player.position,n.SIZE);this.ctx.drawImage(this.playerTexture.source,i.x,i.y,t,t)}renderMask(){const t=this.getMazeCorner(),i=this.getTileSize(),e=Math.floor(this.playerAuraRadius*i),s=this.getRenderPosition(this.player.position,n.SIZE),h=i*n.SIZE,r=`rgba(32, 32, 32, ${this.maskAlpha})`;this.maskCTX.clearRect(0,0,this.mask.width,this.mask.height),this.maskCTX.fillStyle=r,this.maskCTX.fillRect(0,0,this.mask.width,this.mask.height);const o=s.x-t.x+h/2,l=s.y-t.y+h/2;this.maskCTX.beginPath(),this.maskCTX.arc(o,l,e,0,a),this.maskCTX.closePath(),this.maskCTX.save(),this.maskCTX.clip(),this.maskCTX.clearRect(o-e,l-e,2*e,2*e);const d=this.maskCTX.createRadialGradient(o,l,.5*e,o,l,e);d.addColorStop(0,"#0000"),d.addColorStop(.7,"#1118"),d.addColorStop(1,r),this.maskCTX.fillStyle=d,this.maskCTX.fill(),this.maskCTX.fillStyle=`rgba(32, 32, 32, ${1-this.auraIntensity})`,this.maskCTX.fill(),this.maskCTX.restore(),this.ctx.drawImage(this.mask,t.x,t.y)}renderEntities(){for(const t of this.entities)t.render(this)}getMazeCorner(){const t=this.getTileSize();return new e((this.canvas.width-t*this.maze.width)/2,(this.canvas.height-t*this.maze.height)/2)}getTileSize(){return Math.floor(.95*Math.min(this.canvas.width/this.maze.width,this.canvas.height/this.maze.height))}getRenderPosition(t,i){const s=this.getTileSize(),n=i*s,h=this.getMazeCorner();return new e(h.x+t.x*s+.5*(s-n),h.y+(this.maze.height-t.y-1)*s+.5*(s-n))}reset(){this.renderedMaze=0}async initialise(){if(this.initialised)return;const[t,i,e]=await Promise.all([h.create("/Luminight/tiles/wall.png"),h.create("/Luminight/tiles/dirt.png"),h.create("/Luminight/player/player.png","/Luminight/player/player-flipped.png")]);e.framesPerFrame=10,this.wallTexture=t,this.dirtTexture=i,this.playerTexture=e,this.initialised=1}}function o(t){return t[Math.floor(Math.random()*t.length)]}function l(t){return t.splice(0,t.length)}class d{constructor(t=1/0){i(this,"array"),i(this,"maxLength"),this.array=[],this.maxLength=t}*[Symbol.iterator](){for(let t=0;t<this.array.length;t++)yield this.array[t]}add(t){this.array.includes(t)||this.array.length===this.maxLength||this.array.push(t)}remove(t){const i=this.array.indexOf(t);-1!==i&&this.array.splice(i,1)}get(t){return this.array[t]}has(t){return this.array.includes(t)}random(){return o(this.array)}indexOf(t){return this.array.indexOf(t)}clear(){l(this.array)}get size(){return this.array.length}}class m{constructor(t,e){i(this,"width"),i(this,"height"),i(this,"tiles"),this.tiles=[],this.width=t%2==0?t+1:t,this.height=e%2==0?e+1:e}create(){l(this.tiles);for(let t=0;t<this.width;t++)for(let i=0;i<this.height;i++)this.tiles.push({position:new e(i,t),isWall:1});const t=this.getTile(1,1),i=new d,s=new Set;for(t.isWall=0,s.add(this.getTileIndex(t)),i.add(this.getTile(3,1)),i.add(this.getTile(1,3));i.size>0;){const t=i.random(),n=this.getNeighbours(t,2),h=o(n.filter(t=>s.has(this.getTileIndex(t.tile)))),a=this.getTile(e.add(t.position,h.direction));s.add(this.getTileIndex(t)),a.isWall=0,t.isWall=0,i.remove(t);for(const t of n)t.tile&&!s.has(this.getTileIndex(t.tile))&&i.add(t.tile)}for(const t of this.tiles)!t.isWall||Math.random()>.01||0===t.position.x||0===t.position.y||t.position.x===this.width-1||t.position.y===this.height-1||(t.isWall=0);return this}getTile(t,i){return t instanceof e&&(i=t.y,t=t.x),this.tiles[this.getTileIndex(t,i)]}getTileIndex(t,i){return"number"!=typeof t&&(i=t.position.y,t=t.position.x),t+this.height*i}getNeighbours(t,i=1){return[new e(1,0),new e(0,1),new e(-1,0),new e(0,-1)].map(s=>({tile:this.getTile(e.add(t.position,e.scale(s,i))),direction:s})).filter(t=>t.tile&&t.tile.position.x>0&&t.tile.position.y>0&&t.tile.position.x<this.width-1&&t.tile.position.y<this.height-1)}*[Symbol.iterator](){yield*this.tiles}}class c{constructor(t={}){i(this,"settings"),i(this,"callbacks",[]),i(this,"frameID"),i(this,"lastFrameTime"),i(this,"totalTime"),i(this,"frame"),this.frameID=null,this.lastFrameTime=0,this.totalTime=0,this.frame=1,this.callbacks=[],this.settings={wormholeThreshold:t.wormholeThreshold??500}}start(){this.running||(this.frame=1,this.totalTime=0,this.lastFrameTime=-1,this.frameID=requestAnimationFrame(this.tick.bind(this)))}stop(){this.running&&(cancelAnimationFrame(this.frameID),this.frameID=null)}toggle(){this.running?this.stop():this.start()}addCallback(t){this.callbacks.push(t)}tick(t){this.lastFrameTime<0&&(this.lastFrameTime=t);const i=t-this.lastFrameTime,e=this.totalTime+i;if(i<this.settings.wormholeThreshold){const t={deltaTime:i,totalTime:e,frame:this.frame++};for(const i of this.callbacks)i(t);this.totalTime=e}this.lastFrameTime=t,null!==this.frameID&&(this.frameID=requestAnimationFrame(this.tick.bind(this)))}get running(){return null!==this.frameID}}class u{constructor(t){i(this,"keybinds"),i(this,"keysDown"),this.keysDown=new Set,this.keybinds=new Set(t)}addEventListeners(){return document.addEventListener("keydown",this.onKeyDown.bind(this)),document.addEventListener("keyup",this.onKeyUp.bind(this)),this}isKeyDown(t){return this.keysDown.has(t)}onKeyDown(t){const i=t.code;this.keybinds.has(i)&&this.keysDown.add(i)}onKeyUp(t){const i=t.code;this.keysDown.delete(i)}}class p{constructor(t){i(this,"position"),i(this,"size"),i(this,"hitboxMultiplier"),i(this,"onCollision"),i(this,"texture"),this.position=new e,this.size=t.size??.5,this.hitboxMultiplier=1,this.texture=t.texture,this.onCollision=t.onCollision??(()=>{})}checkCollisions(t){const i=this.position.x+(1-this.hitboxMultiplier*this.size)/2,e=i+this.size,s=this.position.y+(1-this.hitboxMultiplier*this.size)/2,h=s+this.size,a=t.position.x+(1-n.SIZE)/2,r=a+n.SIZE,o=t.position.y+(1-n.SIZE)/2,l=o+n.SIZE;i<r&&e>a&&s<l&&h>o&&this.onCollision()}render(t){const i=t.getTileSize()*this.size,e=t.getRenderPosition(this.position,this.size);t.ctx.drawImage(this.texture.source,e.x,e.y,i,i)}}class g extends p{constructor(t){super({texture:t,size:1})}static async create(){const t=await h.create(...Array.from({length:32},(t,i)=>"/Luminight/portal/"+(""+(i+1)).padStart(4,"0")+".png"));return new g(t)}randomisePosition(t){do{this.position.x=Math.floor(Math.random()*t.width),this.position.y=Math.floor(Math.random()*t.height)}while(t.getTile(this.position).isWall||this.position.x<t.width/1.5||this.position.y<t.height/1.5)}}class y{constructor(){i(this,"data",[]),i(this,"indexMap",new Map)}left(t){return 2*t+1}right(t){return 2*t+2}parent(t){return Math.floor((t-1)/2)}swap(t,i){[this.data[t],this.data[i]]=[this.data[i],this.data[t]],this.indexMap.set(this.data[t].key,t),this.indexMap.set(this.data[i].key,i)}peek(){return this.data[0]}insert(t,i,e){if(this.indexMap.has(e))return void this.decreasePriority(e,i);const s={value:t,priority:i,key:e};this.data.push(s);const n=this.data.length-1;this.indexMap.set(e,n),this.bubbleUp(n)}bubbleUp(t){for(;t>0&&this.data[this.parent(t)].priority>this.data[t].priority;){const i=this.parent(t);this.swap(t,i),t=i}}extractMin(){if(0===this.data.length)return null;const t=this.data[0],i=this.data.pop();return this.indexMap.delete(t.key),this.data.length>0&&(this.data[0]=i,this.indexMap.set(i.key,0),this.minHeapify(0)),t}minHeapify(t){const i=this.left(t),e=this.right(t);let s=t;i<this.data.length&&this.data[i].priority<this.data[s].priority&&(s=i),e<this.data.length&&this.data[e].priority<this.data[s].priority&&(s=e),s!==t&&(this.swap(t,s),this.minHeapify(s))}decreasePriority(t,i){const e=this.indexMap.get(t);void 0!==e&&(i>=this.data[e].priority||(this.data[e].priority=i,this.bubbleUp(e)))}has(t){return this.indexMap.has(t)}isEmpty(){return 0===this.data.length}size(){return this.data.length}}class f extends p{constructor(t,e){super({texture:t,size:.8}),i(this,"movementSpeed"),i(this,"movementQueue"),this.movementSpeed=e.movementSpeed,this.hitboxMultiplier=.3,this.movementQueue=[]}pathfind(t,i){l(this.movementQueue);const e=new y,s=new Map,n=new Map,h=new Set,a=t=>`${t.x},${t.y}`;for(const t of i){const i=t.position.equals(this.position)?0:1/0,h=a(t.position);s.set(h,i),n.set(h,null),e.insert({tile:t,distance:i},i,h)}for(;!e.isEmpty();){const r=e.extractMin().value.tile,o=a(r.position);if(h.has(o))continue;if(h.add(o),r.position.equals(t))break;const l=s.get(o),d=[[r.position.x+1,r.position.y],[r.position.x-1,r.position.y],[r.position.x,r.position.y+1],[r.position.x,r.position.y-1]];for(const[t,h]of d){const o=i.getTile(t,h);if(void 0===o)continue;if(o.isWall)continue;const d=a(o.position),m=l+1;m<s.get(d)&&(s.set(d,m),n.set(d,r),e.decreasePriority(d,m))}}const r=[];let o=i.getTile(t)||null;for(;o;){r.unshift(o);const t=n.get(a(o.position));if(!t)break;o=t}for(const t of r)this.movementQueue.push(t.position)}tick(t,i){if(0===this.movementQueue.length){const t=new e(0,0);for(;i.getTile(t).isWall&&!t.equals(this.position);)t.x=Math.floor(Math.random()*i.width),t.y=Math.floor(Math.random()*i.height);this.pathfind(t,i)}const s=this.movementQueue[0],n=e.subtract(s,this.position);if(Math.abs(n.x)+Math.abs(n.y)<=.01)return this.movementQueue.shift(),void this.position.round();n.normalise().scale(this.movementSpeed*t),this.position.add(n)}reset(){l(this.movementQueue)}}const x={FORWARD:"KeyW",LEFT:"KeyA",BACKWARDS:"KeyS",RIGHT:"KeyD"};class w{constructor(t={}){var e,s;i(this,"canvas"),i(this,"maze"),i(this,"renderer"),i(this,"player"),i(this,"loop"),i(this,"keyboardManager"),i(this,"keybinds"),i(this,"thunderAudio"),i(this,"playerAuraRadius"),i(this,"movementSpeed"),i(this,"flickerSpeed"),i(this,"flickerRadius"),i(this,"lightningDuration"),i(this,"lightningRarity"),i(this,"lightningBrightness"),i(this,"enemyCount"),i(this,"onWin"),i(this,"onLose"),i(this,"initialised"),i(this,"portal"),i(this,"lightningCurrentLifetime"),this.canvas=document.createElement("canvas"),this.maze=new m((null==(e=t.maze)?void 0:e.width)??20,(null==(s=t.maze)?void 0:s.height)??20).create(),this.player=new n(this.maze),this.renderer=new r(this.canvas,this.maze,this.player),this.loop=new c,this.keybinds=t.keybinds??x,this.keyboardManager=new u(Object.values(this.keybinds)).addEventListeners(),this.movementSpeed=t.movementSpeed??.0025,this.flickerRadius=t.flickerRadius??.04,this.flickerSpeed=t.flickerSpeed??1/160,this.playerAuraRadius=t.playerAuraRadius??2,this.lightningDuration=t.lightningDuration_ms??500,this.lightningRarity=t.lightningRarity??25,this.lightningBrightness=t.lightningBrightness??.8,this.enemyCount=t.enemyCount??5,this.onWin=t.onWin??(()=>{}),this.onLose=t.onLose??(()=>{}),this.renderer.auraIntensity=0,this.lightningCurrentLifetime=0,this.thunderAudio=document.createElement("audio"),this.thunderAudio.volume=.1,this.initialised=0,this.loop.addCallback(this.tick.bind(this))}async initialise(){if(this.initialised)return;await this.renderer.initialise(),this.portal=await g.create(),this.portal.randomisePosition(this.maze),this.portal.onCollision=()=>{this.onWin()},await new Promise((t,i)=>{const e=()=>{t(),this.thunderAudio.removeEventListener("canplaythrough",e)};this.thunderAudio.addEventListener("canplaythrough",e),this.thunderAudio.onerror=i,this.thunderAudio.src="/Luminight/thunder.mp3"}),this.thunderAudio.addEventListener("ended",()=>{this.thunderAudio.pause()});const t=await h.create("/Luminight/ghost.png"),i=Array.from({length:this.enemyCount},()=>{const i=new f(t,{movementSpeed:.8*this.movementSpeed});do{i.position.x=Math.floor(Math.random()*this.maze.width),i.position.y=Math.floor(Math.random()*this.maze.height)}while(i.position.x<this.maze.width/2&&i.position.y<this.maze.height/2||this.maze.getTile(i.position).isWall);return i.onCollision=()=>{this.onLose()},i});this.renderer.entities.push(this.portal,...i),this.initialised=1}reset(){this.maze.create();for(const t of this.renderer.entities)if(t instanceof f){do{t.position.x=Math.floor(Math.random()*this.maze.width),t.position.y=Math.floor(Math.random()*this.maze.height)}while(t.position.x<this.maze.width/2&&t.position.y<this.maze.height/2||this.maze.getTile(t.position).isWall);t.reset()}this.portal.randomisePosition(this.maze),this.player.position.x=1,this.player.position.y=1,this.lightningCurrentLifetime=0,this.renderer.reset()}mount(t){null===this.canvas.parentElement&&t.appendChild(this.canvas)}start(){this.loop.start()}tick(t){this.flicker(t.frame,t.deltaTime),this.lightningFlash(t.deltaTime),this.checkKeyboard(t.deltaTime);for(const i of this.renderer.entities)i.checkCollisions(this.player),i instanceof f&&i.tick(t.deltaTime,this.maze);this.renderer.render()}flicker(t,i){this.renderer.playerAuraRadius=this.playerAuraRadius+this.flickerRadius*Math.cos(t*i*this.flickerSpeed),this.renderer.auraIntensity=Math.min(Math.max(.2,this.renderer.auraIntensity+.15*(Math.random()-.5)),1)}checkKeyboard(t){this.keyboardManager.isKeyDown(this.keybinds.FORWARD)&&this.player.moveY(this.movementSpeed*t),this.keyboardManager.isKeyDown(this.keybinds.BACKWARDS)&&this.player.moveY(-this.movementSpeed*t),this.keyboardManager.isKeyDown(this.keybinds.LEFT)&&this.player.moveX(-this.movementSpeed*t),this.keyboardManager.isKeyDown(this.keybinds.RIGHT)&&this.player.moveX(this.movementSpeed*t)}lightningFlash(t){this.renderer.maskAlpha=1-this.lightningBrightness*this.lightningCurrentLifetime/this.lightningDuration,this.lightningCurrentLifetime=Math.max(this.lightningCurrentLifetime-t,0);const i=1/(this.lightningRarity*t);if(!(Math.random()>i)){if(this.thunderAudio.paused)this.thunderAudio.play();else{const t=this.thunderAudio.cloneNode();t.volume=.1,t.play()}this.lightningCurrentLifetime=this.lightningDuration}}stop(){this.loop.stop()}}(async()=>{const t=document.getElementById("game-container"),i=new w;await i.initialise(),i.mount(t);const e=document.getElementById("start"),s=document.getElementById("restart"),n=document.getElementById("tutorial"),h=document.getElementById("win"),a=document.getElementById("lose"),r=document.getElementById("banner");n.classList.remove("hidden"),i.onWin=()=>{i.stop(),r.classList.remove("hidden"),h.classList.remove("hidden")},i.onLose=()=>{i.stop(),r.classList.remove("hidden"),a.classList.remove("hidden")},s.addEventListener("click",()=>{r.classList.add("hidden"),a.classList.add("hidden"),i.reset(),i.start()}),e.addEventListener("click",()=>{r.classList.add("hidden"),n.classList.add("hidden"),i.start()})})();