var t=Object.defineProperty,e=(e,i,s)=>((e,i,s)=>i in e?t(e,i,{enumerable:1,configurable:1,writable:1,value:s}):e[i]=s)(e,"symbol"!=typeof i?i+"":i,s);!function(){const t=document.createElement("link").relList;if(!(t&&t.supports&&t.supports("modulepreload"))){for(const t of document.querySelectorAll('link[rel="modulepreload"]'))e(t);new MutationObserver(t=>{for(const i of t)if("childList"===i.type)for(const t of i.addedNodes)"LINK"===t.tagName&&"modulepreload"===t.rel&&e(t)}).observe(document,{childList:1,subtree:1})}function e(t){if(t.ep)return;t.ep=1;const e=function(t){const e={};return t.integrity&&(e.integrity=t.integrity),t.referrerPolicy&&(e.referrerPolicy=t.referrerPolicy),"use-credentials"===t.crossOrigin?e.credentials="include":"anonymous"===t.crossOrigin?e.credentials="omit":e.credentials="same-origin",e}(t);fetch(t.href,e)}}();class i{constructor(t=0,i=0){e(this,"x"),e(this,"y"),this.x=t,this.y=i}}const s=class t{constructor(t){e(this,"maze"),e(this,"position"),this.maze=t,this.position=new i(1,1)}moveX(t){this.move(t,0)}moveY(t){this.move(0,t)}move(e,i){var s,a,r,h,n,l,o,d;const m=this.position.x+e,c=this.position.y+i,u=Math.floor(m+t.SIZE/2),y=Math.ceil(m-t.SIZE/2),g=Math.ceil(c-t.SIZE/2),f=Math.floor(c+t.SIZE/2);e<0&&!(null==(s=this.maze.getTile(u,g))?void 0:s.isWall)&&!(null==(a=this.maze.getTile(u,f))?void 0:a.isWall)||e>0&&!(null==(r=this.maze.getTile(y,g))?void 0:r.isWall)&&!(null==(h=this.maze.getTile(y,f))?void 0:h.isWall)||0===e?this.position.x=m:this.position.x=Math.round(m)+Math.sign(e)*t.SIZE/2,i<0&&!(null==(n=this.maze.getTile(u,f))?void 0:n.isWall)&&!(null==(l=this.maze.getTile(y,f))?void 0:l.isWall)||i>0&&!(null==(o=this.maze.getTile(u,g))?void 0:o.isWall)&&!(null==(d=this.maze.getTile(y,g))?void 0:d.isWall)||0===i?this.position.y=c:this.position.y=Math.round(c)+Math.sign(i)*t.SIZE/2}};e(s,"SIZE",.5);let a=s;const r=2*Math.PI;class h{constructor(t,i,s){e(this,"maze"),e(this,"player"),e(this,"playerAuraRadius"),e(this,"auraIntensity"),e(this,"items"),e(this,"ctx"),e(this,"canvas"),e(this,"mask"),e(this,"maskCTX"),e(this,"mazeCanvas"),e(this,"mazeCTX"),e(this,"renderedMaze"),this.maze=i,this.player=s,this.playerAuraRadius=1.5,this.auraIntensity=1,this.canvas=t,this.ctx=t.getContext("2d"),this.mask=document.createElement("canvas"),this.maskCTX=this.mask.getContext("2d"),this.mazeCanvas=document.createElement("canvas"),this.mazeCTX=this.mazeCanvas.getContext("2d"),this.renderedMaze=0,this.items=[],new ResizeObserver(t=>{const e=t[0].devicePixelContentBoxSize[0],i=e.inlineSize,s=e.blockSize;if(0===i||0===s)return;this.canvas.width=i,this.canvas.height=s;const a=this.getTileSize(),r=this.maze.width*a,h=this.maze.height*a;this.mask.width=r,this.mask.height=h,this.mazeCanvas.width=r,this.mazeCanvas.height=h,this.renderedMaze=0,this.render()}).observe(t)}render(){this.ctx.fillStyle="#333",this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height),this.renderMaze(),this.renderItems(),this.renderPlayer(),this.renderMask()}renderMaze(){const t=this.getMazeCorner();if(!this.renderedMaze){const t=this.getTileSize();this.mazeCTX.strokeStyle="#000";for(const e of this.maze){const i=t*e.x,s=t*(this.maze.height-e.y-1);this.mazeCTX.fillStyle=e.isWall?"#000":"#fff",this.mazeCTX.fillRect(i,s,t,t),this.mazeCTX.strokeRect(i,s,t,t)}this.renderedMaze=1}this.ctx.drawImage(this.mazeCanvas,t.x,t.y)}renderPlayer(){const t=a.SIZE*this.getTileSize(),e=this.getRenderPosition(this.player.position,a.SIZE);this.ctx.fillStyle="#f00",this.ctx.fillRect(e.x,e.y,t,t)}renderMask(){const t=this.getMazeCorner(),e=this.getTileSize(),i=Math.floor(this.playerAuraRadius*e),s=this.getRenderPosition(this.player.position,a.SIZE),h=e*a.SIZE;this.maskCTX.fillStyle="#222",this.maskCTX.fillRect(0,0,this.mask.width,this.mask.height);const n=s.x-t.x+h/2,l=s.y-t.y+h/2;this.maskCTX.beginPath(),this.maskCTX.arc(n,l,i,0,r),this.maskCTX.closePath(),this.maskCTX.save(),this.maskCTX.clip(),this.maskCTX.clearRect(n-i,l-i,2*i,2*i);const o=this.maskCTX.createRadialGradient(n,l,.5*i,n,l,i);o.addColorStop(0,"#0000"),o.addColorStop(.7,"#1118"),o.addColorStop(1,"#222"),this.maskCTX.fillStyle=o,this.maskCTX.fill(),this.maskCTX.fillStyle=`rgba(32, 32, 32, ${1-this.auraIntensity})`,this.maskCTX.fill(),this.maskCTX.restore(),this.ctx.drawImage(this.mask,t.x,t.y)}renderItems(){for(const t of this.items)t.render(this)}getMazeCorner(){const t=this.getTileSize();return new i((this.canvas.width-t*this.maze.width)/2,(this.canvas.height-t*this.maze.height)/2)}getTileSize(){return Math.floor(.95*Math.min(this.canvas.width/this.maze.width,this.canvas.height/this.maze.height))}getRenderPosition(t,e){const s=this.getTileSize(),a=e*s,r=this.getMazeCorner();return new i(r.x+t.x*s+.5*(s-a),r.y+(this.maze.height-t.y-1)*s+.5*(s-a))}}function n(t){return t[Math.floor(Math.random()*t.length)]}class l{constructor(t=1/0){e(this,"array"),e(this,"maxLength"),this.array=[],this.maxLength=t}*[Symbol.iterator](){for(let t=0;t<this.array.length;t++)yield this.array[t]}add(t){this.array.includes(t)||this.array.length===this.maxLength||this.array.push(t)}remove(t){const e=this.array.indexOf(t);-1!==e&&this.array.splice(e,1)}get(t){return this.array[t]}has(t){return this.array.includes(t)}random(){return n(this.array)}indexOf(t){return this.array.indexOf(t)}clear(){this.array.splice(0,this.size)}get size(){return this.array.length}}class o{constructor(t,i){e(this,"width"),e(this,"height"),e(this,"tiles"),this.tiles=[],this.width=t%2==0?t+1:t,this.height=i%2==0?i+1:i}create(){this.tiles.splice(0,this.tiles.length);for(let t=0;t<this.width;t++)for(let e=0;e<this.height;e++)this.tiles.push({x:e,y:t,isWall:1});const t=this.getTile(1,1),e=new l,i=new Set;for(t.isWall=0,i.add(this.getTileIndex(t)),e.add(this.getTile(3,1)),e.add(this.getTile(1,3));e.size>0;){const t=e.random(),s=this.getNeighbours(t,2),a=n(s.filter(t=>i.has(this.getTileIndex(t.tile)))),r=this.getTile(t.x+a.direction[0],t.y+a.direction[1]);i.add(this.getTileIndex(t)),r.isWall=0,t.isWall=0,e.remove(t);for(const t of s)t.tile&&!i.has(this.getTileIndex(t.tile))&&e.add(t.tile)}return this}getTile(t,e){return this.tiles[this.getTileIndex(t,e)]}getTileIndex(t,e){return"number"!=typeof t&&(e=t.y,t=t.x),t+this.height*e}getNeighbours(t,e=1){return[[1,0],[0,1],[-1,0],[0,-1]].map(i=>({tile:this.getTile(t.x+i[0]*e,t.y+i[1]*e),direction:i})).filter(t=>t.tile&&t.tile.x>0&&t.tile.y>0&&t.tile.x<this.width-1&&t.tile.y<this.height-1)}*[Symbol.iterator](){yield*this.tiles}}class d{constructor(t={}){e(this,"settings"),e(this,"callbacks",[]),e(this,"frameID"),e(this,"lastFrameTime"),e(this,"totalTime"),e(this,"frame"),this.frameID=null,this.lastFrameTime=0,this.totalTime=0,this.frame=1,this.callbacks=[],this.settings={wormholeThreshold:t.wormholeThreshold??500}}start(){this.running||(this.frame=1,this.totalTime=0,this.lastFrameTime=-1,this.frameID=requestAnimationFrame(this.tick.bind(this)))}stop(){this.running&&(cancelAnimationFrame(this.frameID),this.frameID=null)}toggle(){this.running?this.stop():this.start()}addCallback(t){this.callbacks.push(t)}tick(t){this.lastFrameTime<0&&(this.lastFrameTime=t);const e=t-this.lastFrameTime,i=this.totalTime+e;if(e<this.settings.wormholeThreshold){const t={deltaTime:e,totalTime:i,frame:this.frame++};for(const e of this.callbacks)e(t);this.totalTime=i}this.lastFrameTime=t,this.frameID=requestAnimationFrame(this.tick.bind(this))}get running(){return null!==this.frameID}}class m{constructor(t){e(this,"keybinds"),e(this,"keysDown"),this.keysDown=new Set,this.keybinds=new Set(t)}addEventListeners(){return document.addEventListener("keydown",this.onKeyDown.bind(this)),document.addEventListener("keyup",this.onKeyUp.bind(this)),this}isKeyDown(t){return this.keysDown.has(t)}onKeyDown(t){const e=t.code;this.keybinds.has(e)&&this.keysDown.add(e)}onKeyUp(t){const e=t.code;this.keysDown.delete(e)}}class c{constructor(t){e(this,"position"),e(this,"size"),e(this,"texture"),this.position=new i,this.size=t.size??.5,this.texture=t.texture}render(t){const e=t.getTileSize()*this.size,i=t.getRenderPosition(this.position,this.size);t.ctx.drawImage(this.texture.source,i.x,i.y,e,e)}}class u{constructor(t){e(this,"framesPerFrame"),e(this,"currentFrame"),e(this,"frame"),e(this,"frames"),this.frames=t,this.currentFrame=0,this.frame=0,this.framesPerFrame=1}get source(){return++this.frame%this.framesPerFrame===0&&this.currentFrame++,this.frames[this.currentFrame%this.frames.length]}static async create(...t){const e=t.map(t=>new Promise((e,i)=>{const s=new Image;s.onerror=i,s.onload=()=>{e(s)},s.src=t})),i=await Promise.all(e);return new u(i)}}class y extends c{constructor(t){super({texture:t,size:1})}static async create(){const t=await u.create(...Array.from({length:32},(t,e)=>"/Luminight/portal/"+(""+(e+1)).padStart(4,"0")+".png"));return new y(t)}}const g={FORWARD:"KeyW",LEFT:"KeyA",BACKWARDS:"KeyS",RIGHT:"KeyD"};class f{constructor(t={}){var i,s;e(this,"canvas"),e(this,"maze"),e(this,"renderer"),e(this,"player"),e(this,"loop"),e(this,"keyboardManager"),e(this,"keybinds"),e(this,"playerAuraRadius"),e(this,"movementSpeed"),e(this,"flickerSpeed"),e(this,"flickerRadius"),e(this,"initialised"),e(this,"portal"),this.canvas=document.createElement("canvas"),this.maze=new o((null==(i=t.maze)?void 0:i.width)??30,(null==(s=t.maze)?void 0:s.height)??30).create(),this.player=new a(this.maze),this.renderer=new h(this.canvas,this.maze,this.player),this.loop=new d,this.keybinds=t.keybinds??g,this.keyboardManager=new m(Object.values(this.keybinds)).addEventListeners(),this.movementSpeed=t.movementSpeed??.0025,this.flickerRadius=t.flickerRadius??.04,this.flickerSpeed=t.flickerSpeed??1/160,this.playerAuraRadius=t.playerAuraRadius??1.5,this.initialised=0,this.loop.addCallback(t=>{this.renderer.playerAuraRadius=this.playerAuraRadius+this.flickerRadius*Math.cos(t.frame*t.deltaTime*this.flickerSpeed),this.renderer.auraIntensity=Math.min(Math.max(.2,this.renderer.auraIntensity+.15*(Math.random()-.5)),1),this.keyboardManager.isKeyDown(this.keybinds.FORWARD)&&this.player.moveY(this.movementSpeed*t.deltaTime),this.keyboardManager.isKeyDown(this.keybinds.BACKWARDS)&&this.player.moveY(-this.movementSpeed*t.deltaTime),this.keyboardManager.isKeyDown(this.keybinds.LEFT)&&this.player.moveX(-this.movementSpeed*t.deltaTime),this.keyboardManager.isKeyDown(this.keybinds.RIGHT)&&this.player.moveX(this.movementSpeed*t.deltaTime),this.renderer.render()})}async initialise(){this.initialised||(this.portal=await y.create(),this.portal.position={x:this.maze.width-2,y:this.maze.height-2},this.renderer.items.push(this.portal),this.initialised=1)}mount(t){null===this.canvas.parentElement&&t.appendChild(this.canvas)}start(){this.loop.start()}stop(){this.loop.stop()}}(async()=>{const t=document.getElementById("game-container"),e=new f;await e.initialise(),e.mount(t),e.start()})();