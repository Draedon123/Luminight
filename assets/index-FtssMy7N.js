var t=Object.defineProperty,i=(i,e,s)=>((i,e,s)=>e in i?t(i,e,{enumerable:1,configurable:1,writable:1,value:s}):i[e]=s)(i,"symbol"!=typeof e?e+"":e,s);!function(){const t=document.createElement("link").relList;if(!(t&&t.supports&&t.supports("modulepreload"))){for(const t of document.querySelectorAll('link[rel="modulepreload"]'))i(t);new MutationObserver(t=>{for(const e of t)if("childList"===e.type)for(const t of e.addedNodes)"LINK"===t.tagName&&"modulepreload"===t.rel&&i(t)}).observe(document,{childList:1,subtree:1})}function i(t){if(t.ep)return;t.ep=1;const i=function(t){const i={};return t.integrity&&(i.integrity=t.integrity),t.referrerPolicy&&(i.referrerPolicy=t.referrerPolicy),"use-credentials"===t.crossOrigin?i.credentials="include":"anonymous"===t.crossOrigin?i.credentials="omit":i.credentials="same-origin",i}(t);fetch(t.href,i)}}();class e{constructor(t=0,e=0){i(this,"x"),i(this,"y"),this.x=t,this.y=e}}const s=class t{constructor(t){i(this,"maze"),i(this,"position"),this.maze=t,this.position=new e(1,1)}moveX(t){this.move(t,0)}moveY(t){this.move(0,t)}move(i,e){var s,h,n,a,r,o,l,d;const m=this.position.x+i,c=this.position.y+e,u=Math.floor(m+t.SIZE/2),g=Math.ceil(m-t.SIZE/2),y=Math.ceil(c-t.SIZE/2),p=Math.floor(c+t.SIZE/2);i<0&&!(null==(s=this.maze.getTile(u,y))?void 0:s.isWall)&&!(null==(h=this.maze.getTile(u,p))?void 0:h.isWall)||i>0&&!(null==(n=this.maze.getTile(g,y))?void 0:n.isWall)&&!(null==(a=this.maze.getTile(g,p))?void 0:a.isWall)||0===i?this.position.x=m:this.position.x=Math.round(m)+Math.sign(i)*t.SIZE/2,e<0&&!(null==(r=this.maze.getTile(u,p))?void 0:r.isWall)&&!(null==(o=this.maze.getTile(g,p))?void 0:o.isWall)||e>0&&!(null==(l=this.maze.getTile(u,y))?void 0:l.isWall)&&!(null==(d=this.maze.getTile(g,y))?void 0:d.isWall)||0===e?this.position.y=c:this.position.y=Math.round(c)+Math.sign(e)*t.SIZE/2}};i(s,"SIZE",.5);let h=s;const n=2*Math.PI;class a{constructor(t,e,s){i(this,"maze"),i(this,"player"),i(this,"playerAuraRadius"),i(this,"auraIntensity"),i(this,"maskAlpha"),i(this,"items"),i(this,"ctx"),i(this,"canvas"),i(this,"mask"),i(this,"maskCTX"),i(this,"mazeCanvas"),i(this,"mazeCTX"),i(this,"renderedMaze"),this.maze=e,this.player=s,this.playerAuraRadius=1.5,this.auraIntensity=1,this.maskAlpha=255,this.canvas=t,this.ctx=t.getContext("2d"),this.mask=document.createElement("canvas"),this.maskCTX=this.mask.getContext("2d"),this.mazeCanvas=document.createElement("canvas"),this.mazeCTX=this.mazeCanvas.getContext("2d"),this.renderedMaze=0,this.items=[],new ResizeObserver(t=>{const i=t[0].devicePixelContentBoxSize[0],e=i.inlineSize,s=i.blockSize;if(0===e||0===s)return;this.canvas.width=e,this.canvas.height=s;const h=this.getTileSize(),n=this.maze.width*h,a=this.maze.height*h;this.mask.width=n,this.mask.height=a,this.mazeCanvas.width=n,this.mazeCanvas.height=a,this.renderedMaze=0,this.render()}).observe(t)}render(){this.ctx.fillStyle="#333",this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height),this.renderMaze(),this.renderItems(),this.renderPlayer(),this.renderMask()}renderMaze(){const t=this.getMazeCorner();if(!this.renderedMaze){const t=this.getTileSize();this.mazeCTX.strokeStyle="#000";for(const i of this.maze){const e=t*i.x,s=t*(this.maze.height-i.y-1);this.mazeCTX.fillStyle=i.isWall?"#000":"#fff",this.mazeCTX.fillRect(e,s,t,t),this.mazeCTX.strokeRect(e,s,t,t)}this.renderedMaze=1}this.ctx.drawImage(this.mazeCanvas,t.x,t.y)}renderPlayer(){const t=h.SIZE*this.getTileSize(),i=this.getRenderPosition(this.player.position,h.SIZE);this.ctx.fillStyle="#f00",this.ctx.fillRect(i.x,i.y,t,t)}renderMask(){const t=this.getMazeCorner(),i=this.getTileSize(),e=Math.floor(this.playerAuraRadius*i),s=this.getRenderPosition(this.player.position,h.SIZE),a=i*h.SIZE,r=`rgba(32, 32, 32, ${this.maskAlpha})`;this.maskCTX.clearRect(0,0,this.mask.width,this.mask.height),this.maskCTX.fillStyle=r,this.maskCTX.fillRect(0,0,this.mask.width,this.mask.height);const o=s.x-t.x+a/2,l=s.y-t.y+a/2;this.maskCTX.beginPath(),this.maskCTX.arc(o,l,e,0,n),this.maskCTX.closePath(),this.maskCTX.save(),this.maskCTX.clip(),this.maskCTX.clearRect(o-e,l-e,2*e,2*e);const d=this.maskCTX.createRadialGradient(o,l,.5*e,o,l,e);d.addColorStop(0,"#0000"),d.addColorStop(.7,"#1118"),d.addColorStop(1,r),this.maskCTX.fillStyle=d,this.maskCTX.fill(),this.maskCTX.fillStyle=`rgba(32, 32, 32, ${1-this.auraIntensity})`,this.maskCTX.fill(),this.maskCTX.restore(),this.ctx.drawImage(this.mask,t.x,t.y)}renderItems(){for(const t of this.items)t.render(this)}getMazeCorner(){const t=this.getTileSize();return new e((this.canvas.width-t*this.maze.width)/2,(this.canvas.height-t*this.maze.height)/2)}getTileSize(){return Math.floor(.95*Math.min(this.canvas.width/this.maze.width,this.canvas.height/this.maze.height))}getRenderPosition(t,i){const s=this.getTileSize(),h=i*s,n=this.getMazeCorner();return new e(n.x+t.x*s+.5*(s-h),n.y+(this.maze.height-t.y-1)*s+.5*(s-h))}}function r(t){return t[Math.floor(Math.random()*t.length)]}class o{constructor(t=1/0){i(this,"array"),i(this,"maxLength"),this.array=[],this.maxLength=t}*[Symbol.iterator](){for(let t=0;t<this.array.length;t++)yield this.array[t]}add(t){this.array.includes(t)||this.array.length===this.maxLength||this.array.push(t)}remove(t){const i=this.array.indexOf(t);-1!==i&&this.array.splice(i,1)}get(t){return this.array[t]}has(t){return this.array.includes(t)}random(){return r(this.array)}indexOf(t){return this.array.indexOf(t)}clear(){this.array.splice(0,this.size)}get size(){return this.array.length}}class l{constructor(t,e){i(this,"width"),i(this,"height"),i(this,"tiles"),this.tiles=[],this.width=t%2==0?t+1:t,this.height=e%2==0?e+1:e}create(){this.tiles.splice(0,this.tiles.length);for(let t=0;t<this.width;t++)for(let i=0;i<this.height;i++)this.tiles.push({x:i,y:t,isWall:1});const t=this.getTile(1,1),i=new o,e=new Set;for(t.isWall=0,e.add(this.getTileIndex(t)),i.add(this.getTile(3,1)),i.add(this.getTile(1,3));i.size>0;){const t=i.random(),s=this.getNeighbours(t,2),h=r(s.filter(t=>e.has(this.getTileIndex(t.tile)))),n=this.getTile(t.x+h.direction[0],t.y+h.direction[1]);e.add(this.getTileIndex(t)),n.isWall=0,t.isWall=0,i.remove(t);for(const t of s)t.tile&&!e.has(this.getTileIndex(t.tile))&&i.add(t.tile)}return this}getTile(t,i){return this.tiles[this.getTileIndex(t,i)]}getTileIndex(t,i){return"number"!=typeof t&&(i=t.y,t=t.x),t+this.height*i}getNeighbours(t,i=1){return[[1,0],[0,1],[-1,0],[0,-1]].map(e=>({tile:this.getTile(t.x+e[0]*i,t.y+e[1]*i),direction:e})).filter(t=>t.tile&&t.tile.x>0&&t.tile.y>0&&t.tile.x<this.width-1&&t.tile.y<this.height-1)}*[Symbol.iterator](){yield*this.tiles}}class d{constructor(t={}){i(this,"settings"),i(this,"callbacks",[]),i(this,"frameID"),i(this,"lastFrameTime"),i(this,"totalTime"),i(this,"frame"),this.frameID=null,this.lastFrameTime=0,this.totalTime=0,this.frame=1,this.callbacks=[],this.settings={wormholeThreshold:t.wormholeThreshold??500}}start(){this.running||(this.frame=1,this.totalTime=0,this.lastFrameTime=-1,this.frameID=requestAnimationFrame(this.tick.bind(this)))}stop(){this.running&&(cancelAnimationFrame(this.frameID),this.frameID=null)}toggle(){this.running?this.stop():this.start()}addCallback(t){this.callbacks.push(t)}tick(t){this.lastFrameTime<0&&(this.lastFrameTime=t);const i=t-this.lastFrameTime,e=this.totalTime+i;if(i<this.settings.wormholeThreshold){const t={deltaTime:i,totalTime:e,frame:this.frame++};for(const i of this.callbacks)i(t);this.totalTime=e}this.lastFrameTime=t,null!==this.frameID&&(this.frameID=requestAnimationFrame(this.tick.bind(this)))}get running(){return null!==this.frameID}}class m{constructor(t){i(this,"keybinds"),i(this,"keysDown"),this.keysDown=new Set,this.keybinds=new Set(t)}addEventListeners(){return document.addEventListener("keydown",this.onKeyDown.bind(this)),document.addEventListener("keyup",this.onKeyUp.bind(this)),this}isKeyDown(t){return this.keysDown.has(t)}onKeyDown(t){const i=t.code;this.keybinds.has(i)&&this.keysDown.add(i)}onKeyUp(t){const i=t.code;this.keysDown.delete(i)}}class c{constructor(t){i(this,"position"),i(this,"size"),i(this,"onCollision"),i(this,"texture"),this.position=new e,this.size=t.size??.5,this.texture=t.texture,this.onCollision=t.onCollision??(()=>{})}checkCollisions(t){const i=this.position.x+(1-this.size)/2,e=i+this.size,s=this.position.y+(1-this.size)/2,n=s+this.size,a=t.position.x+(1-h.SIZE)/2,r=a+h.SIZE,o=t.position.y+(1-h.SIZE)/2,l=o+h.SIZE;i<r&&e>a&&s<l&&n>o&&this.onCollision()}render(t){const i=t.getTileSize()*this.size,e=t.getRenderPosition(this.position,this.size);t.ctx.drawImage(this.texture.source,e.x,e.y,i,i)}}class u{constructor(t){i(this,"framesPerFrame"),i(this,"currentFrame"),i(this,"frame"),i(this,"frames"),this.frames=t,this.currentFrame=0,this.frame=0,this.framesPerFrame=1}get source(){return++this.frame%this.framesPerFrame===0&&this.currentFrame++,this.frames[this.currentFrame%this.frames.length]}static async create(...t){const i=t.map(t=>new Promise((i,e)=>{const s=new Image;s.onerror=e,s.onload=()=>{i(s)},s.src=t})),e=await Promise.all(i);return new u(e)}}class g extends c{constructor(t){super({texture:t,size:1})}static async create(){const t=await u.create(...Array.from({length:32},(t,i)=>"/Luminight/portal/"+(""+(i+1)).padStart(4,"0")+".png"));return new g(t)}}const y={FORWARD:"KeyW",LEFT:"KeyA",BACKWARDS:"KeyS",RIGHT:"KeyD"};class p{constructor(t={}){var e,s;i(this,"canvas"),i(this,"maze"),i(this,"renderer"),i(this,"player"),i(this,"loop"),i(this,"keyboardManager"),i(this,"keybinds"),i(this,"thunderAudio"),i(this,"playerAuraRadius"),i(this,"movementSpeed"),i(this,"flickerSpeed"),i(this,"flickerRadius"),i(this,"lightningDuration"),i(this,"lightningRarity"),i(this,"lightningBrightness"),i(this,"onWin"),i(this,"onLose"),i(this,"initialised"),i(this,"portal"),i(this,"lightningCurrentLifetime"),this.canvas=document.createElement("canvas"),this.maze=new l((null==(e=t.maze)?void 0:e.width)??30,(null==(s=t.maze)?void 0:s.height)??30).create(),this.player=new h(this.maze),this.renderer=new a(this.canvas,this.maze,this.player),this.loop=new d,this.keybinds=t.keybinds??y,this.keyboardManager=new m(Object.values(this.keybinds)).addEventListeners(),this.movementSpeed=t.movementSpeed??.0025,this.flickerRadius=t.flickerRadius??.04,this.flickerSpeed=t.flickerSpeed??1/160,this.playerAuraRadius=t.playerAuraRadius??1.5,this.lightningDuration=t.lightningDuration_ms??500,this.lightningRarity=t.lightningRarity??30,this.lightningBrightness=t.lightningBrightness??.8,this.onWin=t.onWin??(()=>{}),this.onLose=t.onLose??(()=>{}),this.renderer.auraIntensity=0,this.lightningCurrentLifetime=0,this.thunderAudio=document.createElement("audio"),this.thunderAudio.volume=.1,this.initialised=0,this.loop.addCallback(this.tick.bind(this))}async initialise(){this.initialised||(this.portal=await g.create(),this.portal.position={x:this.maze.width-2,y:this.maze.height-2},this.portal.onCollision=()=>{this.stop(),this.onWin()},await new Promise((t,i)=>{const e=()=>{t(),this.thunderAudio.removeEventListener("canplaythrough",e)};this.thunderAudio.addEventListener("canplaythrough",e),this.thunderAudio.onerror=i,this.thunderAudio.src="/Luminight/thunder.mp3"}),this.thunderAudio.addEventListener("ended",()=>{this.thunderAudio.pause()}),this.renderer.items.push(this.portal),this.initialised=1)}mount(t){null===this.canvas.parentElement&&t.appendChild(this.canvas)}start(){this.loop.start()}tick(t){this.flicker(t.frame,t.deltaTime),this.lightningFlash(t.deltaTime),this.checkKeyboard(t.deltaTime);for(const t of this.renderer.items)t.checkCollisions(this.player);this.renderer.render()}flicker(t,i){this.renderer.playerAuraRadius=this.playerAuraRadius+this.flickerRadius*Math.cos(t*i*this.flickerSpeed),this.renderer.auraIntensity=Math.min(Math.max(.2,this.renderer.auraIntensity+.15*(Math.random()-.5)),1)}checkKeyboard(t){this.keyboardManager.isKeyDown(this.keybinds.FORWARD)&&this.player.moveY(this.movementSpeed*t),this.keyboardManager.isKeyDown(this.keybinds.BACKWARDS)&&this.player.moveY(-this.movementSpeed*t),this.keyboardManager.isKeyDown(this.keybinds.LEFT)&&this.player.moveX(-this.movementSpeed*t),this.keyboardManager.isKeyDown(this.keybinds.RIGHT)&&this.player.moveX(this.movementSpeed*t)}lightningFlash(t){this.renderer.maskAlpha=1-this.lightningBrightness*this.lightningCurrentLifetime/this.lightningDuration,this.lightningCurrentLifetime=Math.max(this.lightningCurrentLifetime-t,0);const i=1/(this.lightningRarity*t);if(!(Math.random()>i)){if(this.thunderAudio.paused)this.thunderAudio.play();else{const t=this.thunderAudio.cloneNode();t.volume=.1,t.play()}this.lightningCurrentLifetime=this.lightningDuration}}stop(){this.loop.stop()}}(async()=>{const t=document.getElementById("game-container"),i=new p;await i.initialise(),i.mount(t);const e=document.getElementById("start"),s=document.getElementById("tutorial"),h=document.getElementById("win"),n=document.getElementById("banner");s.classList.remove("hidden"),i.onWin=()=>{n.classList.remove("hidden"),h.classList.remove("hidden")},e.addEventListener("click",()=>{n.classList.add("hidden"),s.classList.add("hidden"),i.start()})})();