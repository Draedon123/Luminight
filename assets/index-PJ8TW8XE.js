var t=Object.defineProperty,e=(e,i,s)=>((e,i,s)=>i in e?t(e,i,{enumerable:1,configurable:1,writable:1,value:s}):e[i]=s)(e,"symbol"!=typeof i?i+"":i,s);function i(t){return t[Math.floor(Math.random()*t.length)]}!function(){const t=document.createElement("link").relList;if(!(t&&t.supports&&t.supports("modulepreload"))){for(const t of document.querySelectorAll('link[rel="modulepreload"]'))e(t);new MutationObserver(t=>{for(const i of t)if("childList"===i.type)for(const t of i.addedNodes)"LINK"===t.tagName&&"modulepreload"===t.rel&&e(t)}).observe(document,{childList:1,subtree:1})}function e(t){if(t.ep)return;t.ep=1;const e=function(t){const e={};return t.integrity&&(e.integrity=t.integrity),t.referrerPolicy&&(e.referrerPolicy=t.referrerPolicy),"use-credentials"===t.crossOrigin?e.credentials="include":"anonymous"===t.crossOrigin?e.credentials="omit":e.credentials="same-origin",e}(t);fetch(t.href,e)}}();class s{constructor(t=1/0){e(this,"array"),e(this,"maxLength"),this.array=[],this.maxLength=t}*[Symbol.iterator](){for(let t=0;t<this.array.length;t++)yield this.array[t]}add(t){this.array.includes(t)||this.array.length===this.maxLength||this.array.push(t)}remove(t){const e=this.array.indexOf(t);-1!==e&&this.array.splice(e,1)}get(t){return this.array[t]}has(t){return this.array.includes(t)}random(){return i(this.array)}indexOf(t){return this.array.indexOf(t)}clear(){this.array.splice(0,this.size)}get size(){return this.array.length}}class h{constructor(t,i){e(this,"width"),e(this,"height"),e(this,"tiles"),this.tiles=[],this.width=t%2==0?t+1:t,this.height=i%2==0?i+1:i}create(){this.tiles.splice(0,this.tiles.length);for(let t=0;t<this.width;t++)for(let e=0;e<this.height;e++)this.tiles.push({x:e,y:t,isWall:1});const t=this.getTile(1,1),e=new s,h=new Set;for(t.isWall=0,h.add(this.getTileIndex(t)),e.add(this.getTile(3,1)),e.add(this.getTile(1,3));e.size>0;){const t=e.random(),s=this.getNeighbours(t,2),a=i(s.filter(t=>h.has(this.getTileIndex(t.tile)))),r=this.getTile(t.x+a.direction[0],t.y+a.direction[1]);h.add(this.getTileIndex(t)),r.isWall=0,t.isWall=0,e.remove(t);for(const t of s)t.tile&&!h.has(this.getTileIndex(t.tile))&&e.add(t.tile)}}getTile(t,e){return this.tiles[this.getTileIndex(t,e)]}getTileIndex(t,e){return"number"!=typeof t&&(e=t.y,t=t.x),t+this.height*e}getNeighbours(t,e=1){return[[1,0],[0,1],[-1,0],[0,-1]].map(i=>({tile:this.getTile(t.x+i[0]*e,t.y+i[1]*e),direction:i})).filter(t=>t.tile&&t.tile.x>0&&t.tile.y>0&&t.tile.x<this.width-1&&t.tile.y<this.height-1)}*[Symbol.iterator](){yield*this.tiles}}class a{constructor(t=0,i=0){e(this,"x"),e(this,"y"),this.x=t,this.y=i}}class r{constructor(t){e(this,"maze"),e(this,"position"),e(this,"rotation"),e(this,"fov"),this.maze=t,this.position=new a(1,1),this.rotation=0,this.fov=45}}e(r,"SIZE",.75);const n=Math.PI/180;function o(t){return n*t}const l=2*Math.PI,c=document.getElementById("main"),d=new h(30,30);d.create();const m=new r(d),y=new class{constructor(t,i,s){e(this,"maze"),e(this,"player"),e(this,"playerAuraRadius"),e(this,"canvas"),e(this,"ctx"),e(this,"mask"),e(this,"maskCTX"),this.maze=i,this.player=s,this.playerAuraRadius=1.5,this.canvas=t,this.ctx=t.getContext("2d"),this.mask=document.createElement("canvas"),this.maskCTX=this.mask.getContext("2d"),new ResizeObserver(t=>{const e=t[0].devicePixelContentBoxSize[0],i=e.inlineSize,s=e.blockSize;this.canvas.width=i,this.canvas.height=s;const h=this.getTileSize(),a=this.maze.width*h,r=this.maze.height*h;this.mask.width=a,this.mask.height=r,this.render()}).observe(t)}render(){this.ctx.fillStyle="#333",this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height),this.renderMaze(),this.renderPlayer(),this.renderMask()}renderMaze(){const t=this.getTileSize(),e=this.getMazeCorner();for(const i of this.maze){const s=t*i.x+e.x,h=t*i.y+e.y;this.ctx.fillStyle=i.isWall?"#000":"#fff",this.ctx.fillRect(s,h,t,t)}}renderPlayer(){const t=this.getTileSize(),e=r.SIZE*t,i=this.getPlayerRenderPosition();this.ctx.fillStyle="#f00";const s=i.x+.5*e;this.ctx.save(),this.ctx.translate(s,i.y+e/2),this.ctx.rotate(o(this.player.rotation)),this.ctx.beginPath(),this.ctx.moveTo(-.7*e/2,e/2),this.ctx.lineTo(.7*e/2,e/2),this.ctx.lineTo(0,-e/2),this.ctx.lineTo(-.7*e/2,e/2),this.ctx.closePath(),this.ctx.fill(),this.ctx.restore()}renderMask(){const t=this.getMazeCorner(),e=this.getTileSize(),i=this.playerAuraRadius*e,s=this.getPlayerRenderPosition(),h=e*r.SIZE;this.maskCTX.fillStyle="#222",this.maskCTX.fillRect(0,0,this.mask.width,this.mask.height);const a=s.x-t.x+h/2,n=s.y-t.y+h/2;this.maskCTX.beginPath(),this.maskCTX.arc(a,n,i,0,l),this.maskCTX.closePath(),this.maskCTX.save(),this.maskCTX.clip(),this.maskCTX.clearRect(a-i,n-i,2*i,2*i),this.maskCTX.restore();const o=this.maskCTX.createRadialGradient(a,n,.5*i,a,n,i);o.addColorStop(0,"#0000"),o.addColorStop(.7,"#1118"),o.addColorStop(1,"#222"),this.maskCTX.fillStyle=o,this.maskCTX.fill(),this.ctx.drawImage(this.mask,t.x,t.y)}getTileSize(){return Math.floor(.95*Math.min(this.canvas.width/this.maze.width,this.canvas.height/this.maze.height))}getMazeCorner(){const t=this.getTileSize();return new a((this.canvas.width-t*this.maze.width)/2,(this.canvas.height-t*this.maze.height)/2)}getPlayerRenderPosition(){const t=this.getTileSize(),e=r.SIZE*t,i=this.getMazeCorner();return new a(i.x+this.player.position.x*t+.5*(t-e),i.y+(this.maze.height-this.player.position.y-1)*t+.5*(t-e))}}(c,d,m),g=new class{constructor(t={}){e(this,"settings"),e(this,"callbacks",[]),e(this,"frameID"),e(this,"lastFrameTime"),e(this,"totalTime"),e(this,"frame"),this.frameID=null,this.lastFrameTime=0,this.totalTime=0,this.frame=1,this.callbacks=[],this.settings={wormholeThreshold:t.wormholeThreshold??500}}start(){this.running||(this.frame=1,this.totalTime=0,this.lastFrameTime=-1,this.frameID=requestAnimationFrame(this.tick.bind(this)))}stop(){this.running&&(cancelAnimationFrame(this.frameID),this.frameID=null)}toggle(){this.running?this.stop():this.start()}addCallback(t){this.callbacks.push(t)}tick(t){this.lastFrameTime<0&&(this.lastFrameTime=t);const e=t-this.lastFrameTime,i=this.totalTime+e;if(e<this.settings.wormholeThreshold){const t={deltaTime:e,totalTime:i,frame:this.frame++};for(const e of this.callbacks)e(t);this.totalTime=i}this.lastFrameTime=t,this.frameID=requestAnimationFrame(this.tick.bind(this))}get running(){return null!==this.frameID}},T={FORWARD:"KeyW",LEFT:"KeyA",BACKWARDS:"KeyS",RIGHT:"KeyD",ROTATE_LEFT:"ArrowLeft",ROTATE_RIGHT:"ArrowRight"},u=new class{constructor(t){e(this,"keybinds"),e(this,"keysDown"),this.keysDown=new Set,this.keybinds=new Set(t)}addEventListeners(){document.addEventListener("keydown",this.onKeyDown.bind(this)),document.addEventListener("keyup",this.onKeyUp.bind(this))}isKeyDown(t){return this.keysDown.has(t)}onKeyDown(t){const e=t.code;this.keybinds.has(e)&&this.keysDown.add(e)}onKeyUp(t){const e=t.code;this.keysDown.delete(e)}}(Object.values(T));u.addEventListeners();const f=.0025;g.addCallback(t=>{const e=Math.sin(o(m.rotation)),i=Math.cos(o(m.rotation));u.isKeyDown(T.FORWARD)&&(m.position.x+=e*f*t.deltaTime,m.position.y+=i*f*t.deltaTime),u.isKeyDown(T.BACKWARDS)&&(m.position.x-=e*f*t.deltaTime,m.position.y-=i*f*t.deltaTime),u.isKeyDown(T.LEFT)&&(m.position.x-=i*f*t.deltaTime,m.position.y+=e*f*t.deltaTime),u.isKeyDown(T.RIGHT)&&(m.position.x+=i*f*t.deltaTime,m.position.y-=e*f*t.deltaTime),u.isKeyDown(T.ROTATE_RIGHT)&&(m.rotation+=.25*t.deltaTime),u.isKeyDown(T.ROTATE_LEFT)&&(m.rotation-=.25*t.deltaTime),y.render()}),g.start();